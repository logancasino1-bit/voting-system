<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>User Settings</title>

<style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:"Poppins",sans-serif; }
    body { background:#f2f4f7; display:flex; justify-content:center; padding:20px; }

    .settings-container {
        width:95%; max-width:850px; background:white; padding:25px; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,0.1); animation:fadeIn .4s ease;
    }
    @keyframes fadeIn { from{opacity:0; transform:translateY(15px);} to{opacity:1; transform:translateY(0);} }

    .top-bar { display:flex; align-items:center; margin-bottom:25px; }
    .back-btn { padding:10px 15px; background:#1a73e8; color:white; border-radius:8px; cursor:pointer; border:none; margin-right:15px; }
    .back-btn:hover { background:#0d58c7; }
    .top-bar h2 { color:#1a73e8; font-size:24px; font-weight:600; }

    .profile-box { text-align:center; margin-bottom:30px; }
    #profilePreview { width:130px; height:130px; border-radius:50%; object-fit:cover; border:4px solid #1a73e8; margin-bottom:12px; }

    .section { background:#f8f9fc; padding:20px; margin-bottom:20px; border-radius:12px; border:1px solid #ddd; }
    .section label { display:block; font-weight:600; margin-top:8px; margin-bottom:5px; }
    .section input { width:100%; padding:12px; border-radius:8px; border:1px solid #bfc7d8; margin-bottom:10px; }
    .save-btn { width:100%; background:#1a73e8; border:none; padding:12px; border-radius:8px; color:white; margin-top:10px; cursor:pointer; }
    .save-btn:hover { background:#0b5dc7; }
    .danger-btn { background:#d9534f !important; }
    .danger-btn:hover { background:#c3423f !important; }

    @media(max-width:600px){ #profilePreview{ width:100px; height:100px; } }

    /* ---------------- LOGOUT MODAL ---------------- */
    .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999; opacity:0; transition:opacity 0.3s ease; }
    .modal-overlay.show { display:flex; opacity:1; }
    .modal-content { background:white; padding:30px; border-radius:12px; text-align:center; max-width:400px; width:90%; transform:scale(0.8); transition:transform 0.3s ease; }
    .modal-overlay.show .modal-content { transform:scale(1); }
    .modal-buttons { margin-top:20px; display:flex; justify-content:space-around; }
    .modal-buttons button { padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }
    #confirmLogout{ background:#ff4c4c; color:white; } #cancelLogout{ background:#ccc; color:black; }
</style>
</head>
<body>

<div class="settings-container">

    <!-- HEADER / BACK BUTTON -->
    <div class="top-bar">
        <button class="back-btn" onclick="goBack()">‚Üê Back</button>
        <h2>Account Settings</h2>
    </div>

    <!-- PROFILE PICTURE -->
    <div class="profile-box">
        <img id="profilePreview" src="">
        <br>
        <input type="file" id="profileUpload" accept="image/*">
        <button class="save-btn" id="savePhoto">Change Profile Picture</button>
    </div>

    <!-- NAME -->
    <div class="section">
        <label>First Name</label>
        <input id="firstNameInput" type="text">
        <label>Last Name</label>
        <input id="lastNameInput" type="text">
        <button class="save-btn" id="saveName">Save Name</button>
    </div>

    <!-- EMAIL -->
    <div class="section">
        <label>New Email</label>
        <input id="newEmailInput" type="email">
        <button class="save-btn" id="saveEmail">Update Email</button>
    </div>

    <!-- PASSWORD -->
    <div class="section">
        <label>New Password</label>
        <input id="newPasswordInput" type="password">
        <button class="save-btn" id="savePassword">Change Password</button>
    </div>

    <!-- LOGOUT BUTTON -->
    <button class="save-btn danger-btn" onclick="showLogoutModal()">Logout</button>

</div>

<!-- LOGOUT CONFIRMATION MODAL -->
<div id="logoutModal" class="modal-overlay">
    <div class="modal-content">
        <h3>Are you sure you want to logout?</h3>
        <div class="modal-buttons">
            <button id="confirmLogout">Yes, Logout</button>
            <button id="cancelLogout">Cancel</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, onAuthStateChanged, updateEmail, updatePassword, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

const firebaseConfig = {
    apiKey: "AIzaSyBrMco-_L76Prf7dkCOu3QfBTC5DTB315M",
    authDomain: "login-form-d9e8b.firebaseapp.com",
    projectId: "login-form-d9e8b",
    storageBucket: "login-form-d9e8b.appspot.com",
    messagingSenderId: "780297703902",
    appId: "1:780297703902:web:3f1acdbce4faf06aff0d4f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();
const storage = getStorage();

/* ------------------ LOAD USER INFO ------------------ */
onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location.href = "user_login.html";
    const snap = await getDoc(doc(db, "users", user.uid));
    const data = snap.data();
    profilePreview.src = data.photoURL || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
    firstNameInput.value = data.first_name;
    lastNameInput.value = data.last_name;
});

/* ------------------ UPDATE NAME ------------------ */
saveName.onclick = async () => {
    const user = auth.currentUser;
    await updateDoc(doc(db, "users", user.uid), { first_name:firstNameInput.value, last_name:lastNameInput.value });
    alert("Name updated!");
};

/* ------------------ UPDATE EMAIL ------------------ */
saveEmail.onclick = async () => {
    const user = auth.currentUser;
    await updateEmail(user, newEmailInput.value);
    await updateDoc(doc(db, "users", user.uid), { email:newEmailInput.value });
    alert("Email updated!");
};

/* ------------------ UPDATE PASSWORD ------------------ */
savePassword.onclick = async () => {
    if(newPasswordInput.value.length<6) return alert("Password must be at least 6 characters.");
    await updatePassword(auth.currentUser,newPasswordInput.value);
    alert("Password updated!");
};

/* ------------------ UPDATE PHOTO ------------------ */
savePhoto.onclick = async () => {
    const file = profileUpload.files[0];
    if(!file) return alert("Please select an image.");
    const user = auth.currentUser;
    const storageRef = ref(storage, `profilePhotos/${user.uid}`);
    await uploadBytes(storageRef, file);
    const url = await getDownloadURL(storageRef);
    await updateDoc(doc(db,"users",user.uid),{ photoURL:url });
    profilePreview.src = url;
    alert("Profile picture updated!");
};

/* ------------------ BACK BUTTON ------------------ */
window.goBack = ()=> window.location.href="user_dashboard.html";

/* ------------------ LOGOUT MODAL ------------------ */
const logoutModal = document.getElementById("logoutModal");
const confirmBtn = document.getElementById("confirmLogout");
const cancelBtn = document.getElementById("cancelLogout");

window.showLogoutModal = ()=> logoutModal.classList.add("show");
cancelBtn.addEventListener("click", ()=> logoutModal.classList.remove("show"));
logoutModal.addEventListener("click", e=>{ if(e.target===logoutModal) logoutModal.classList.remove("show"); });

window.logoutUser = ()=> {
    signOut(auth).then(()=>{
        localStorage.removeItem("loggedInUserId");
        window.location.href="user_login.html";
    }).catch(err=>console.error("Logout error:",err));
};

confirmBtn.addEventListener("click", ()=>{
    logoutModal.classList.remove("show");
    logoutUser();
});
</script>
</body>
</html>
