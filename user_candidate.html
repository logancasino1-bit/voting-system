<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Candidate Application</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="global.css"> <!-- Includes modal styles -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
    <h2>INFORMATICS VOTING SYSTEM</h2>

    <div class="profile">
        <img id="userPhoto" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="User Profile">
        <h3 id="userName">Loading...</h3>
        <p id="userRole">Loading...</p>
        <p id="userEmail" style="font-size: 12px; opacity: .7;">Loading...</p>
    </div>

    <div class="menu-links">
        <a href="user_dashboard.html">ğŸ  Dashboard</a>
        <a href="user_candidate.html">ğŸ“ Candidate</a>
        <a href="user_organization.html">ğŸ‘¥ Organizations</a>
        <a href="user_notification.html">ğŸ”” Notifications</a>
        <a href="user_support.html">ğŸ’¬ Help</a>
    </div>

    <div class="sidebar-bottom">
        <a href="user_settings.html" class="sidebar-bottom-link">
            <i class="fas fa-cog"></i> Settings
        </a>
        <a href="javascript:void(0)" onclick="showLogoutModal()" class="sidebar-bottom-link logout">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </div>
</div>

<div class="container">
    <h2>Apply as Candidate</h2>

    <div class="candidate-wrapper">

    <!-- Qualifications Section -->
    <div class="qualifications" id="qualifications">
        <h3>Candidate Qualifications</h3>
        <p>Before applying, please ensure you meet the following qualifications:</p>
        <ul>
            <li>Must be at least 18 years old.</li>
            <li>Must be an active student or member of the organization.</li>
            <li>Must have no disciplinary actions.</li>
            <li>Must be committed to fulfilling the role responsibilities.</li>
        </ul>
        <button id="proceedBtn">Proceed to Application</button>
    </div>

    <!-- Candidate Form (Hidden Initially) -->
    <form id="candidateForm" style="display:none;">
        <h2>Apply as Candidate</h2>
        <input type="text" id="fullName" placeholder="Full Name" required>
        <input type="number" id="age" placeholder="Age" required>
        <input type="text" id="achievements" placeholder="Achievements" required>
        <select id="position" required>
            <option value="">Select Position</option>
            <option value="President">President</option>
            <option value="Vice President">Vice President</option>
            <option value="Secretary">Secretary</option>
            <option value="Treasurer">Treasurer</option>
            <option value="Auditor">Auditor</option>
        </select>
        <textarea id="manifesto" placeholder="Your manifesto..." rows="6" required></textarea>
        <button type="submit">Submit Application</button>
    </form>

</div>


<!-- Logout Confirmation Modal -->
<div id="logoutModal" class="modal-overlay">
    <div class="modal-content">
        <h3>Are you sure you want to logout?</h3>
        <div class="modal-buttons">
            <button id="confirmLogout">Yes, Logout</button>
            <button id="cancelLogout">Cancel</button>
        </div>
    </div>
</div>

<!-- Scripts -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, addDoc, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBrMco-_L76Prf7dkCOu3QfBTC5DTB315M",
  authDomain: "login-form-d9e8b.firebaseapp.com",
  projectId: "login-form-d9e8b",
  storageBucket: "login-form-d9e8b.appspot.com",
  messagingSenderId: "780297703902",
  appId: "1:780297703902:web:3f1acdbce4faf06aff0d4f",
  measurementId: "G-VTZ78CJHES"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

// Helper function to show notifications
function showNotification(message, type = "info", duration = 3000) {
    const notif = document.createElement("div");
    notif.textContent = message;
    notif.style.position = "fixed";
    notif.style.top = "20px";
    notif.style.right = "20px";
    notif.style.padding = "12px 20px";
    notif.style.backgroundColor = type === "error" ? "#f44336" : "#4caf50";
    notif.style.color = "#fff";
    notif.style.borderRadius = "6px";
    notif.style.boxShadow = "0 2px 8px rgba(0,0,0,0.3)";
    notif.style.zIndex = 1000;
    notif.style.fontWeight = "bold";
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), duration);
}

// Load user info
onAuthStateChanged(auth, async (user) => {
    if(!user) return window.location.href = "user_login.html";
    try {
        const uid = user.uid;
        const snap = await getDoc(doc(db, "users", uid));
        const data = snap.exists() ? snap.data() : {};
        const firstName = data.first_name || user.displayName || "User";
        const lastName = data.last_name || "";
        const role = (data.role || "USER").toUpperCase();
        const email = data.email || user.email;
        const photoURL = data.photoURL || "https://cdn-icons-png.flaticon.com/512/149/149071.png";

        document.getElementById("userName").textContent = `${firstName} ${lastName}`.trim();
        document.getElementById("userRole").textContent = role;
        document.getElementById("userEmail").textContent = email;
        document.getElementById("userPhoto").src = photoURL;
        document.getElementById("fullName").value = `${firstName} ${lastName}`.trim();
    } catch(err) { console.error(err); }
});

// Candidate form submission
document.getElementById("candidateForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const fullName = document.getElementById("fullName").value.trim();
    const position = document.getElementById("position").value;
    const manifesto = document.getElementById("manifesto").value.trim();
    const uid = auth.currentUser.uid;

    if(!fullName || !position || !manifesto) {
        showNotification("Please fill all fields.", "error");
        return;
    }

    try {
        // Check if user already submitted any application
        const q = query(collection(db, "candidates"), where("uid", "==", uid));
        const existing = await getDocs(q);

        if(!existing.empty) {
            showNotification(`You have already submitted a candidate application.`, "error");
            return;
        }

        // Save to Firestore
        await addDoc(collection(db, "candidates"), {
            fullName,
            position,
            manifesto,
            uid,
            timestamp: serverTimestamp()
        });

        showNotification("Application submitted successfully!", "success");
        document.getElementById("candidateForm").reset();
        document.getElementById("fullName").value = fullName;

    } catch(err) {
        console.error("Error submitting application:", err);
        showNotification("Failed to submit application.", "error");
    }
});


// Proceed button logic
const proceedBtn = document.getElementById("proceedBtn");
const qualifications = document.getElementById("qualifications");
const candidateForm = document.getElementById("candidateForm");

proceedBtn.addEventListener("click", () => {
    qualifications.style.display = "none";
    candidateForm.style.display = "block";
    candidateForm.scrollIntoView({ behavior: "smooth" });
});
</script>

<!-- Logout JS (reusable for all user pages) -->
<script type="module" src="logout.js"></script>

</body>
</html>
